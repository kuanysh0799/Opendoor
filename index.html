<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>OpenDoor CRM</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="theme-color" content="#0b1220">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <img src="logo.png" class="brand__logo" alt="OpenDoor">
      <div class="brand__text">
        <div class="brand__title">OpenDoor CRM</div>
        <div class="brand__subtitle">Продажи дверей · PWA</div>
      </div>
    </div>
    <div class="hdr-actions">
      <button id="installBtn" class="btn ghost">Установить</button>
      <div id="userBox" class="userbox"></div>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab is-active" data-tab="funnel">Воронка</button>
    <button class="tab" data-tab="deals">Сделки</button>
    <button class="tab" data-tab="clients">Клиенты</button>
    <button class="tab" data-tab="reports">Отчёты</button>
    <button class="tab" data-tab="settings">Настройки</button>
  </nav>

  <section class="kpi">
    <span class="pill" id="kpi-lead">Лид: 0</span>
    <span class="pill" id="kpi-delivery">Доставка: 0</span>
    <span class="pill" id="kpi-install">Установка: 0</span>
    <label class="chk"><input type="checkbox" id="showArchive"> показать архив</label>
  </section>

  <main class="content">
    <!-- Funnel -->
    <section id="tab-funnel" class="pane is-active">
      <div class="row">
        <input id="dealSearch" class="input" placeholder="Поиск сделки…">
      </div>
      <div id="funnel" class="funnel"></div>
      <button id="fab" class="fab" title="Новая сделка">＋</button>
    </section>

    <!-- Deals list -->
    <section id="tab-deals" class="pane">
      <div class="row">
        <input id="dealSearchList" class="input" placeholder="Поиск сделки…">
      </div>
      <div id="dealsList" class="list"></div>
    </section>

    <!-- Clients -->
    <section id="tab-clients" class="pane">
      <div class="row">
        <input id="clientSearch" class="input" placeholder="Поиск клиента…">
        <button id="newClientBtn" class="btn">+ Клиент</button>
      </div>
      <div id="clientsList" class="list"></div>
    </section>

    <!-- Reports -->
    <section id="tab-reports" class="pane">
      <div class="filters">
        <button class="chip is-active" data-range="day">Сегодня</button>
        <button class="chip" data-range="week">Неделя</button>
        <button class="chip" data-range="month">Месяц</button>
        <button class="chip" data-range="3m">3 мес</button>
        <button class="chip" data-range="6m">6 мес</button>
      </div>
      <div id="reports" class="cards"></div>
      <div class="row end">
        <button id="archiveDoneBtn" class="btn danger small">Архивировать завершённые</button>
      </div>
    </section>

    <!-- Settings -->
    <section id="tab-settings" class="pane">
      <h3>Настройки</h3>
      <p class="muted">Удалять клиентов/сделки может только владелец (owner). Роль берётся из Firestore: <code>users/{uid}.role</code>.</p>
    </section>
  </main>

  <!-- Client modal -->
  <dialog id="clientDialog" class="modal">
    <form method="dialog" id="clientForm" class="modal__body">
      <h3 id="clientDialogTitle">Клиент</h3>
      <div class="grid">
        <label>Имя <input name="name" class="input" required></label>
        <label>Телефон <input name="phone" class="input" placeholder="+7707…"></label>
        <label>Источник <input name="source" class="input" placeholder="Instagram / WhatsApp / 2ГИС"></label>
        <label>Адрес <input name="address" class="input"></label>
        <label>Заметки <textarea name="notes" class="input" rows="3"></textarea></label>
      </div>
      <div class="row end">
        <button id="clientRepeatBtn" class="btn ghost small" type="button">Повторная покупка</button>
        <button class="btn ghost" value="cancel">Отмена</button>
        <button id="clientSaveBtn" class="btn primary" value="default">Сохранить</button>
        <button id="clientDeleteBtn" class="btn danger" type="button">Удалить</button>
      </div>
    </form>
  </dialog>

  <!-- Deal modal -->
  <dialog id="dealDialog" class="modal">
    <form method="dialog" id="dealForm" class="modal__body">
      <h3 id="dealDialogTitle">Новая сделка</h3>
      <div class="grid">
        <label>Клиент <input name="name" class="input" required></label>
        <label>Телефон <input name="phone" class="input" placeholder="+7707…"></label>
        <label>Сумма (₸) <input name="total" class="input" type="number" min="0" step="1"></label>
        <label>Маржа (₸) <input name="margin" class="input" type="number" min="0" step="1"></label>
        <label>Источник <input name="source" class="input" placeholder="Instagram / 2ГИС / WhatsApp"></label>
        <label>Этап
          <select name="stage" class="input">
            <option value="lead">Лид</option>
            <option value="consult">Консультация</option>
            <option value="kp">КП/Накладная</option>
            <option value="pay">Оплата</option>
            <option value="delivery">Доставка</option>
            <option value="install">Установка</option>
          </select>
        </label>
        <label>Заметки <textarea name="notes" class="input" rows="3"></textarea></label>
      </div>
      <div class="row end">
        <button class="btn ghost" value="cancel">Отмена</button>
        <button id="dealSaveBtn" class="btn primary" value="default">Сохранить</button>
      </div>
    </form>
  </dialog>

  <div id="toast" class="toast"></div>

  <script type="module" src="app.js"></script>
</body>
</html>
