<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>OpenDoor CRM · Продажи дверей · PWA</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="theme-color" content="#0f172a">
  <link rel="stylesheet" href="styles.css">
  <script>
    // iOS: disable double-tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      var now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) { event.preventDefault(); }
      lastTouchEnd = now;
    }, false);
  </script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img src="logo.png" alt="OpenDoor" class="logo">
      <div class="brand-txt">
        <div class="title">OpenDoor CRM</div>
        <div class="sub">Продажи дверей · PWA</div>
      </div>
    </div>

    <div class="top-actions">
      <button id="installBtn" class="btn ghost">Установить</button>
      <div id="userBox" class="userbox hidden">
        <img id="userPhoto" class="avatar" alt="">
        <span id="userName" class="uname"></span>
        <button id="logoutBtn" class="btn danger">Выйти</button>
      </div>
      <button id="loginBtn" class="btn primary">Войти через Google</button>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab active" data-tab="pipeline">Воронка</button>
    <button class="tab" data-tab="deals">Сделки</button>
    <button class="tab" data-tab="clients">Клиенты</button>
    <button class="tab" data-tab="reports">Отчёты</button>
    <button class="tab" data-tab="settings">Настройки</button>
  </nav>

  <!-- Counters row -->
  <section class="counters">
    <span class="pill" id="cnt-lead">Лид: 0</span>
    <span class="pill" id="cnt-consult">Консультация: 0</span>
    <span class="pill" id="cnt-kp">КП/накладная: 0</span>
    <span class="pill" id="cnt-pay">Оплата: 0</span>
    <span class="pill" id="cnt-delivery">Доставка: 0</span>
    <span class="pill" id="cnt-install">Установка: 0</span>
    <label class="chk">
      <input type="checkbox" id="showArchive"> показать архив
    </label>
  </section>

  <!-- Pipeline -->
  <main id="pipeline" class="tab-body active">
    <div class="pipeline-grid" id="pipeGrid">
      <!-- columns render by JS -->
    </div>
    <button class="fab" id="addDealFab">＋</button>
  </main>

  <!-- Deals list -->
  <main id="deals" class="tab-body">
    <div class="toolbar">
      <input id="searchDeals" class="search" placeholder="Поиск сделки...">
    </div>
    <div id="dealsList" class="list"></div>
  </main>

  <!-- Clients -->
  <main id="clients" class="tab-body">
    <div class="toolbar">
      <input id="searchClients" class="search" placeholder="Поиск клиента...">
    </div>
    <div id="clientsList" class="list"></div>
  </main>

  <!-- Reports -->
  <main id="reports" class="tab-body">
    <div class="toolbar wrap">
      <button class="btn chip" data-range="1d">Сегодня</button>
      <button class="btn chip" data-range="7d">Неделя</button>
      <button class="btn chip" data-range="30d">Месяц</button>
      <button class="btn chip" data-range="90d">3 мес</button>
      <button class="btn chip" data-range="180d">6 мес</button>
    </div>
    <section class="cards">
      <div class="card">
        <div class="card-title">Сделок</div>
        <div id="repDeals" class="big">0</div>
      </div>
      <div class="card">
        <div class="card-title">Выручка</div>
        <div id="repRevenue" class="big">0 ₸</div>
      </div>
      <div class="card">
        <div class="card-title">По этапам</div>
        <div id="repStages" class="mini"></div>
      </div>
      <div class="card">
        <div class="card-title">Топ-клиенты</div>
        <ol id="repTop" class="mini"></ol>
      </div>
    </section>
  </main>

  <!-- Settings -->
  <main id="settings" class="tab-body">
    <h3>Настройки</h3>
    <p>Данные клиента можно редактировать в карточке клиента.</p>
    <p id="roleInfo"></p>
  </main>

  <!-- Modals -->
  <dialog id="dealModal" class="modal">
    <form method="dialog" id="dealForm">
      <h3 id="dealModalTitle">Новая сделка</h3>
      <div class="grid-2">
        <label>Клиент <input name="client" required></label>
        <label>Телефон <input name="phone" placeholder="+7…" required></label>
      </div>
      <div class="grid-2">
        <label>Сумма (₸) <input type="number" name="amount" min="0" step="1000"></label>
        <label>Источник
          <select name="source">
            <option>Instagram</option>
            <option>WhatsApp</option>
            <option>Звонок</option>
            <option>2ГИС</option>
            <option>Рекомендации</option>
            <option>Визит в магазин</option>
          </select>
        </label>
      </div>
      <div class="grid-2">
        <label>Этап
          <select name="stage">
            <option value="lead">Лид</option>
            <option value="consult">Консультация</option>
            <option value="kp">КП/накладная</option>
            <option value="pay">Оплата</option>
            <option value="delivery">Доставка</option>
            <option value="install">Установка</option>
          </select>
        </label>
        <label>Примечание <input name="note" placeholder="коротко"></label>
      </div>
      <menu>
        <button class="btn ghost" value="cancel">Отмена</button>
        <button class="btn primary" value="default">Сохранить</button>
      </menu>
    </form>
  </dialog>

  <dialog id="clientModal" class="modal">
    <form method="dialog" id="clientForm">
      <h3>Клиент</h3>
      <div class="grid-2">
        <label>Имя <input name="name" required></label>
        <label>Телефон <input name="phone" required></label>
      </div>
      <div class="grid-2">
        <label>Адрес <input name="address"></label>
        <label>Источник
          <select name="source">
            <option>Instagram</option>
            <option>WhatsApp</option>
            <option>Звонок</option>
            <option>2ГИС</option>
            <option>Рекомендации</option>
            <option>Визит в магазин</option>
          </select>
        </label>
      </div>
      <label>Заметки <textarea name="notes" rows="3"></textarea></label>
      <menu>
        <button class="btn danger" id="clientDeleteBtn" type="button">Удалить</button>
        <span class="spacer"></span>
        <button class="btn ghost" value="cancel">Отмена</button>
        <button class="btn primary" value="default">Сохранить</button>
      </menu>
      <div class="right">
        <button class="btn" id="repeatBuyBtn" type="button">Повторная покупка</button>
      </div>
    </form>
  </dialog>

  <script type="module" src="app.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(()=>{});
      });
    }
  </script>
</body>
</html>
